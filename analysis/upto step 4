
from Bio import SeqIO
from Bio.SeqUtils import gc_fraction
from Bio.Blast import NCBIWWW
from Bio.SeqRecord import SeqRecord

# STEP 1: Read DNA sequence

dna_record = SeqIO.read("rat.fasta","fasta")
dna_seq = dna_record.seq

print("Sequence ID:", dna_record.id)
print("DNA length:", len(dna_seq))

# STEP 2: Quality check (GC%)

gc = gc_fraction(dna_seq) * 100
print("GC Content:", round(gc, 2), "%")

# STEP 3: DNA validation

if len(dna_seq) < 300:
    print("Sequence too short. Analysis stopped.")
    exit()
else:
    print("Sequence accepted for analysis")

# STEP 4: Translate DNA â†’ Protein

print("Translating DNA to protein...")

protein_seq = dna_seq.translate(to_stop=True)
print("Protein length:", len(protein_seq))

# Save protein FASTA
protein_record = SeqRecord(
    protein_seq,
    id="Unknown_protein",
    description="Translated protein sequence"
)

SeqIO.write(protein_record, "protein.fasta", "fasta")
print("Protein FASTA file created")

# STEP 5: Homology search (ONLINE BLASTp)

print("Submitting protein to NCBI BLASTp (this may take time)...")

result_handle = NCBIWWW.qblast(
    program="blastp",
    database="nr",
    sequence=protein_seq
)

with open("blast_result.xml", "w") as out_handle:
    out_handle.write(result_handle.read())

print("BLAST search completed")

# STEP 5: Functional Annotation (BLAST result interpretation)

print("Performing functional annotation...")

with open("blast_result.xml") as result_handle:
    blast_record = NCBIXML.read(result_handle)

# Open output file
with open("functional_annotation.txt", "w") as out:

    out.write("FUNCTIONAL ANNOTATION REPORT\n")
    out.write("="*50 + "\n\n")

    out.write(f"Query ID: {blast_record.query}\n")
    out.write(f"Query Length: {blast_record.query_length}\n\n")

    # Check if hits are present
    if not blast_record.alignments:
        out.write("No significant BLAST hits found.\n")
    else:
        out.write("Top BLAST Hits:\n\n")

        # Extract top 5 hits
        for alignment in blast_record.alignments[:5]:
            hsp = alignment.hsps[0]

            out.write(f"Protein: {alignment.title}\n")
            out.write(f"Length: {alignment.length}\n")
            out.write(f"E-value: {hsp.expect}\n")
            out.write(f"Identity: {hsp.identities}/{hsp.align_length}\n")
            out.write(f"Percent Identity: {round((hsp.identities/hsp.align_length)*100, 2)}%\n")
            out.write("-"*40 + "\n")

print("Functional annotation file created: functional_annotation.txt")

